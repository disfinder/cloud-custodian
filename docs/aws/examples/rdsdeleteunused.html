

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RDS - Delete Unused Databases With No Connections &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/icon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/js/expand.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/expand.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="RDS - Terminate Unencrypted Public Instances" href="rdspublicunencrypted.html" />
    <link rel="prev" title="Example offhours policy" href="offhours.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filters.html">Generic Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../actions.html">Generic Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/advanced.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/policyStructure.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment.html">Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">AWS</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example Policies</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="accountinvalidiplogin.html">Account - Login From Invalid IP Address</a></li>
<li class="toctree-l2"><a class="reference internal" href="accountrootlogin.html">Account - Detect Root Logins</a></li>
<li class="toctree-l2"><a class="reference internal" href="accountservicelimit.html">Account - Service Limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="amicomp.html">AMI - Stop EC2 using Unapproved AMIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="asginvalidconfig.html">AutoScaling Group - Verify ASGs have valid configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="asgoffhours.html">ASG - Offhours Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="blocknonstandardregionresources.html">Block New Resources In Non-Standard Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="dmsenforcessl.html">DMS - DB Migration Service Endpoint - Enforce SSL</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebsgarbagecollect.html">EBS - Garbage Collect Unattached Volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebssnapshots.html">EBS - Create and Manage Snapshots</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebsunencrypted.html">EBS - Delete Unencrypted</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2-auto-tag-user.html">EC2 - auto-tag aws userName on resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2offhours.html">EC2 - Offhours Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2oldinstances.html">EC2 - Old Instance Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2poweronstoppedforpatching.html">EC2 - Power On For Scheduled Patching</a></li>
<li class="toctree-l2"><a class="reference internal" href="ec2unpatchedworkflow.html">EC2 - Terminate Unpatchable Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbdeleteinetfacing.html">ELB - Delete New Internet-Facing ELBs</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbgarbagecollection.html">ELB - Delete Unused Elastic Load Balancers</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbsslblacklist.html">ELB - SSL Blacklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="elbsslwhitelist.html">ELB - SSL Whitelist</a></li>
<li class="toctree-l2"><a class="reference internal" href="iamsetrolepolicy.html">IAM - Manage Whether A Specific IAM Policy is Attached to Roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="lambdaerrorsnotify.html">Lambda - Notify On Lambda Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="offhours.html">Example offhours policy</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">RDS - Delete Unused Databases With No Connections</a></li>
<li class="toctree-l2"><a class="reference internal" href="rdspublicunencrypted.html">RDS - Terminate Unencrypted Public Instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="s3configurenewbucket.html">S3 - Configure New Buckets Settings and Standards</a></li>
<li class="toctree-l2"><a class="reference internal" href="s3denypublicobjectacls.html">S3 - Block Public S3 Object ACLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="s3encryption.html">S3 - Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="s3globalgrants.html">S3 - Global Grants</a></li>
<li class="toctree-l2"><a class="reference internal" href="sagemakernotebookdeletepublicorunencrypted.html">SageMaker Notebook - Delete Public or Unencrypted</a></li>
<li class="toctree-l2"><a class="reference internal" href="securitygroupsdetectremediate.html">Security Groups - Detect and Remediate Violations</a></li>
<li class="toctree-l2"><a class="reference internal" href="tagcompliance.html">Tag Compliance Across Resources (EC2, ASG, ELB, S3, etc)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vpcflowlog.html">VPC - Flow Log Configuration Check</a></li>
<li class="toctree-l2"><a class="reference internal" href="vpcpeeringcrossaccount.html">VPC - Notify On Invalid External Peering Connections</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../aws-modes.html">AWS Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources/index.html">AWS Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Azure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../azure/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/authentication.html">Authentication &amp; Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/policy/index.html">Supported Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/azure-modes.html">Azure Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/advanced/index.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/contribute.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../azure/resources/index.html">Azure Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">GCP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/gettingstarted.html">Getting Started (Beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/gcp-modes.html">GCP Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/policy/index.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/contribute.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/contribute.html#adding-new-gcp-resources">Adding New GCP Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/contribute.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gcp/resources/index.html">GCP Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-org.html">c7n-org: Multi Account Custodian Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-policystream.html">c7n-policystream: Policy Changes from Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-mailer.html">c7n-mailer: Custodian Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/c7n-trailcreator.html">AWS Retroactive Tagging Resource Creators</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/installing.html">Installing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/tests.html">Testing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/documentation.html">Documentation For Developers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Custodian</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Example Policies</a> &raquo;</li>
        
      <li>RDS - Delete Unused Databases With No Connections</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rds-delete-unused-databases-with-no-connections">
<span id="rdsdeleteunused"></span><h1>RDS - Delete Unused Databases With No Connections<a class="headerlink" href="#rds-delete-unused-databases-with-no-connections" title="Permalink to this headline">¶</a></h1>
<p>The following example policy workflow uses the mark-for-op and marked-for-op filters and
actions to chain together a set of policies to accomplish a task.  In this example it
will find any RDS that is older than 14 days that has had no connections to it in the last
14 days and tag it with a delete op and date 14 days out. The policy workflow will also
email the RDS resource owner to inform them of the upcoming stopping and deletion if the
RDS remains unused. If a customer connects to the RDS before the 14 day window it will
get unmarked so it doesn’t get deleted.</p>
<p>Note the use of the notify action requires the Cloud Custodian mailer to be installed
and configured.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vars</span><span class="p">:</span>
  <span class="nt">metrics-filters</span><span class="p">:</span> <span class="nl">&amp;metrics-filter</span>
        <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">metrics</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DatabaseConnections</span>
        <span class="nt">days</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
        <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
        <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">equal</span>

<span class="nt">policies</span><span class="p">:</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-notify-step1</span>
  <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Take the average number of connections over 14 days for databases that are greater than 14</span>
    <span class="no">days old and notify the resources owner on any unused RDS and mark for delete action in 14 days.</span>
  <span class="nt">filters</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">greater-than</span>
    <span class="p p-Indicator">-</span> <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="nt">or</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="nt">actions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mark-for-op</span>
      <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="nt">days</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="nt">priority_header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">subject</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="nt">violation_desc</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">Instance</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">had</span><span class="nv"> </span><span class="s">no</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">weeks</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">unused:&quot;</span>
      <span class="nt">action_desc</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;Actions Taken:  Database deletion has been scheduled for 14 days from now.</span>
          <span class="no">At this point we are just notifying you of the upcoming deletion if not used.&quot;</span>
      <span class="nt">to</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CloudCustodian@Company.com</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-notify-step2</span>
  <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Take the average number of connections over 21</span>
    <span class="no">days and notify on any unused RDS that have already been marked for delete</span>
  <span class="nt">filters</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">marked-for-op</span>
      <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="nt">skew</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">7</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">21</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="nt">or</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="nt">actions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="nt">priority_header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">subject</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">URGENT</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="nt">violation_desc</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;RDS Instance has had no connections in the last 3 weeks and is unused and will be stopped</span>
          <span class="no">hourly in 5 days (if supported by DB type) and then deleted 2 days after its stopped:&quot;</span>
      <span class="nt">action_desc</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;Actions Taken:  Hourly database stopping and email will occur in 5 days and deleted will occur in 7 days.</span>
          <span class="no">At this point we are just notifying you of the upcoming stoppage and deleted if not used&quot;</span>
      <span class="nt">to</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-stop-and-nag-hourly-step3</span>
  <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="nt">mode</span><span class="p">:</span>
      <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">periodic</span>
      <span class="nt">schedule</span><span class="p">:</span> <span class="s">&quot;rate(1</span><span class="nv"> </span><span class="s">hour)&quot;</span>
      <span class="nt">timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">300</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">This policy deploys a Lambda function with an hourly CloudWatch Event Schedule trigger.</span>
    <span class="no">The policy takes the average number of connections over 26 days and stops the RDS and</span>
    <span class="no">notifies the resource owner hourly on any of their unused databases that have already</span>
    <span class="no">been marked for deletion.</span>
  <span class="nt">filters</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">marked-for-op</span>
      <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="nt">skew</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">26</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="nt">or</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="nt">actions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="nt">priority_header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">subject</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">URGENT!!!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="nt">violation_desc</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;RDS Instance has had no connections in the last 26 days and is unused</span>
          <span class="no">and will be deleted in less than 48 hours&quot;</span>
      <span class="nt">action_desc</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;Actions Taken: Hourly Stopping of RDS and notify.  Deletion will occur in less than</span>
          <span class="no">48 hours. Please connect to the RDS or snapshot it if you don&#39;t need it at this time.&quot;</span>
      <span class="nt">to</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-delete-step4</span>
  <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">Take the average number of connections over 28 days and delete</span>
    <span class="no">any unused databases that have already been marked for delete</span>
  <span class="nt">filters</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">marked-for-op</span>
      <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">c7n_rds_unused</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">28</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="nt">&lt;&lt;</span><span class="p">:</span> <span class="nv">*metrics-filter</span>
    <span class="p p-Indicator">-</span> <span class="nt">or</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="nt">actions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">delete</span>
      <span class="nt">skip-snapshot</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="nt">priority_header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">subject</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">URGENT!!!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">Database</span><span class="nv"> </span><span class="s">Deleted!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="nt">violation_desc</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">Instance</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">had</span><span class="nv"> </span><span class="s">no</span><span class="nv"> </span><span class="s">connections</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">28</span><span class="nv"> </span><span class="s">days</span><span class="nv"> </span><span class="s">and</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">deleted.&quot;</span>
      <span class="nt">action_desc</span><span class="p">:</span> <span class="s">&quot;Actions</span><span class="nv"> </span><span class="s">Taken:</span><span class="nv"> </span><span class="s">RDS</span><span class="nv"> </span><span class="s">Instance(s)</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">deleted.&quot;</span>
      <span class="nt">to</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CloudCustodian@Company.com</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds-unused-databases-unmark</span>
  <span class="nt">resource</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rds</span>
  <span class="nt">description</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">The policy takes the average number of connections over 14 days and if there are connections</span>
    <span class="no">then unmark the RDS instance and notify the resource owner.</span>
  <span class="nt">filters</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="s">&quot;tag:c7n_rds_unused&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">value</span>
      <span class="nt">value_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">age</span>
      <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">InstanceCreateTime</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gte</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">metrics</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DatabaseConnections</span>
      <span class="nt">days</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
      <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
      <span class="nt">op</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gt</span>
    <span class="p p-Indicator">-</span> <span class="nt">or</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:Resource</span><span class="nv"> </span><span class="s">Contact&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;tag:CreatorName&quot;</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="nt">actions</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">unmark</span>
      <span class="nt">tags</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;c7n_rds_unused&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">notify</span>
      <span class="nt">template</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default.html</span>
      <span class="nt">priority_header</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">subject</span><span class="p">:</span> <span class="s">&quot;RDS</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">Previously</span><span class="nv"> </span><span class="s">Unused</span><span class="nv"> </span><span class="s">DB</span><span class="nv"> </span><span class="s">Unmarked!</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">[custodian</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">account</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">region</span><span class="nv"> </span><span class="s">}}]&quot;</span>
      <span class="nt">violation_desc</span><span class="p">:</span> <span class="p p-Indicator">|</span>
          <span class="no">&quot;RDS Instance that previously had no connections for over 2 weeks is now showing</span>
          <span class="no">connections and it has been unmarked for deletion.&quot;</span>
      <span class="nt">action_desc</span><span class="p">:</span> <span class="s">&quot;Actions</span><span class="nv"> </span><span class="s">Taken:</span><span class="nv"> </span><span class="s">RDS</span><span class="nv"> </span><span class="s">Instance(s)</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">been</span><span class="nv"> </span><span class="s">unmarked.</span><span class="nv"> </span><span class="s">No</span><span class="nv"> </span><span class="s">further</span><span class="nv"> </span><span class="s">action</span><span class="nv"> </span><span class="s">needed&quot;</span>
      <span class="nt">to</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">CloudCustodian@Company.com</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">resource-owner</span>
      <span class="nt">transport</span><span class="p">:</span>
          <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sqs</span>
          <span class="nt">queue</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://sqs.us-east-1.amazonaws.com/12345678900/cloud-custodian-mailer</span>
          <span class="nt">region</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">us-east-1</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rdspublicunencrypted.html" class="btn btn-neutral float-right" title="RDS - Terminate Unencrypted Public Instances" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="offhours.html" class="btn btn-neutral float-left" title="Example offhours policy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>