Azure Common Filters
====================

Filters


   - :ref:`diagnostic-settings <Azure.common.filters.diagnostic-settings>`


   - :ref:`event <Azure.common.filters.event>`


   - :ref:`firewall-rules <Azure.common.filters.firewall-rules>`


   - :ref:`instance-view <Azure.common.filters.instance-view>`


   - :ref:`marked-for-op <Azure.common.filters.marked-for-op>`


   - :ref:`metric <Azure.common.filters.metric>`


   - :ref:`offhour <Azure.common.filters.offhour>`


   - :ref:`onhour <Azure.common.filters.onhour>`


   - :ref:`policy-compliant <Azure.common.filters.policy-compliant>`


   - :ref:`resource-lock <Azure.common.filters.resource-lock>`


   - :ref:`storage-diagnostic-settings <Azure.common.filters.storage-diagnostic-settings>`


   - :ref:`value <Azure.common.filters.value>`




.. _Azure.common.filters.diagnostic-settings:

diagnostic-settings
+++++++++++++++++++



.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - diagnostic-settings
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
    required:
    - type



.. _Azure.common.filters.event:

event
+++++

Filter a resource based on an event.

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - event
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
    required:
    - type



.. _Azure.common.filters.firewall-rules:

firewall-rules
++++++++++++++

Filters resources by the firewall rules

:example:

.. code-block:: yaml

        policies:
            - name: servers-with-firewall
              resource: azure.sqlserver
              filters:
                  - type: firewall-rules
                    include:
                        - '131.107.160.2-131.107.160.3'
                        - 10.20.20.0/24

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      equal:
        items:
          type: string
        type: array
      include:
        items:
          type: string
        type: array
      type:
        enum:
        - firewall-rules
    required:
    - type



.. _Azure.common.filters.instance-view:

instance-view
+++++++++++++



.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - instance-view
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
    required:
    - type



.. _Azure.common.filters.marked-for-op:

marked-for-op
+++++++++++++

Filter resources for tag specified future action

Filters resources by a 'custodian_status' tag which specifies a future
date for an action.

The filter parses the tag values looking for an 'op@date'
string. The date is parsed and compared to do today's date, the
filter succeeds if today's date is gte to the target date.

The optional 'skew' parameter provides for incrementing today's
date a number of days into the future. An example use case might
be sending a final notice email a few days before terminating an
instance, or snapshotting a volume prior to deletion.

The optional 'skew_hours' parameter provides for incrementing the current
time a number of hours into the future.

Optionally, the 'tz' parameter can get used to specify the timezone
in which to interpret the clock (default value is 'utc')

.. code-block :: yaml

   policies:
    - name: vm-stop-marked
      resource: azure.vm
      filters:
        - type: marked-for-op
          # The default tag used is custodian_status
          # but that is configurable
          tag: custodian_status
          op: stop
          # Another optional tag is skew
          tz: utc
      actions:
        - type: stop

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      op:
        type: string
      skew:
        minimum: 0
        type: number
      skew_hours:
        minimum: 0
        type: number
      tag:
        type: string
      type:
        enum:
        - marked-for-op
      tz:
        type: string
    required:
    - type



.. _Azure.common.filters.metric:

metric
++++++

Filters Azure resources based on live metrics from the Azure monitor

:example: Find all VMs with an average Percentage CPU greater than 75% over last 2 hours

.. code-block:: yaml

        policies:
          - name: vm-percentage-cpu
            resource: azure.vm
            filters:
              - type: metric
                metric: Percentage CPU
                aggregation: average
                op: gt
                threshold: 75
                timeframe: 2

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      aggregation:
        enum:
        - total
        - average
      filter:
        type: string
      interval:
        enum:
        - PT1M
        - PT5M
        - PT15M
        - PT30M
        - PT1H
        - PT6H
        - PT12H
        - P1D
      metric:
        type: string
      no_data_action:
        enum:
        - include
        - exclude
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
      threshold:
        type: number
      timeframe:
        type: number
      type:
        enum:
        - metric
    required:
    - type
    - metric
    - op
    - threshold



.. _Azure.common.filters.offhour:

offhour
+++++++

Schedule offhours for resources see :ref:`offhours <offhours>`
for features and configuration.

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default_tz:
        type: string
      offhour:
        maximum: 23
        minimum: 0
        type: integer
      opt-out:
        type: boolean
      skip-days:
        items:
          pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}
          type: string
        type: array
      skip-days-from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      tag:
        type: string
      type:
        enum:
        - offhour
      weekends:
        type: boolean
      weekends-only:
        type: boolean
    required:
    - offhour
    - default_tz
    - type



.. _Azure.common.filters.onhour:

onhour
++++++

Schedule offhours for resources see :ref:`offhours <offhours>`
for features and configuration.

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default_tz:
        type: string
      onhour:
        maximum: 23
        minimum: 0
        type: integer
      opt-out:
        type: boolean
      skip-days:
        items:
          pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}
          type: string
        type: array
      skip-days-from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      tag:
        type: string
      type:
        enum:
        - onhour
      weekends:
        type: boolean
      weekends-only:
        type: boolean
    required:
    - onhour
    - default_tz
    - type



.. _Azure.common.filters.policy-compliant:

policy-compliant
++++++++++++++++

Filter resources based on Azure Policy compliance status

Filter resources by their current Azure Policy compliance status.

You can specify if you want to filter compliant or non-compliant resources.

You can provide a list of Azure Policy definitions display names or names to limit
amount of non-compliant resources. By default it returns a list of all non-compliant
resources.

.. code-block :: yaml

   policies:
    - name: non-compliant-vms
      resource: azure.vm
      filters:
        - type: policy-compliant
          compliant: false
          definitions:
            - "Definition display name 1"
            - "Definition display name 2"

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      compliant:
        type: boolean
      definitions:
        type: array
      type:
        enum:
        - policy-compliant
    required:
    - type
    - compliant
    - type



.. _Azure.common.filters.resource-lock:

resource-lock
+++++++++++++

Filter locked resources.
Lock can be of 2 types: ReadOnly and CanNotDelete. To filter any lock, use "Any" type.
Lock type is optional, by default any lock will be applied to the filter.
To get unlocked resources, use "Absent" type.

:example: Get all keyvaults with ReadOnly lock:

.. code-block :: yaml

   policies:
    - name: locked-keyvaults
      resource: azure.keyvault
      filters:
        - type: resource-lock
          lock-type: ReadOnly

:example: Get all locked sqldatabases (any type of lock):

.. code-block :: yaml

   policies:
    - name: locked-sqldatabases
      resource: azure.sqldatabase
      filters:
        - type: resource-lock

:example: Get all unlocked resource groups:

.. code-block :: yaml

   policies:
    - name: unlock-rgs
      resource: azure.resourcegroup
      filters:
        - type: resource-lock
          lock-type: Absent

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      lock-type:
        enum:
        - ReadOnly
        - CanNotDelete
        - Any
        - Absent
      type:
        enum:
        - resource-lock
    required:
    - type
    - type



.. _Azure.common.filters.storage-diagnostic-settings:

storage-diagnostic-settings
+++++++++++++++++++++++++++

Filters storage accounts based on its diagnostic settings. The filter requires
specifying the storage type (blob, queue, table, file) and will filter based on
the settings for that specific type.

 :example:

    Find all storage accounts that have a 'delete' logging setting disabled.

 .. code-block:: yaml

    policies:
        - name: find-accounts-with-delete-logging-disabled
          resource: azure.storage
          filters:
            - or:
                - type: storage-diagnostic-settings
                  storage-type: blob
                  key: logging.delete
                  op: eq
                  value: False
                - type: storage-diagnostic-settings
                  storage-type: queue
                  key: logging.delete
                  op: eq
                  value: False
                - type: storage-diagnostic-settings
                  storage-type: table
                  key: logging.delete
                  op: eq
                  value: False

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      storage-type:
        enum:
        - blob
        - queue
        - table
        - file
        type: string
      type:
        enum:
        - storage-diagnostic-settings
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
    required:
    - storage-type
    - type



.. _Azure.common.filters.value:

value
+++++

Generic value filter using jmespath
    

.. container:: toggle

  

  .. raw:: html
     
    <div class="header docutils container" style=""></div>

  .. code-block:: yaml

    properties:
      default:
        type: object
      key:
        type: string
      op:
        enum:
        - eq
        - equal
        - ne
        - not-equal
        - gt
        - greater-than
        - ge
        - gte
        - le
        - lte
        - lt
        - less-than
        - glob
        - regex
        - regex-case
        - in
        - ni
        - not-in
        - contains
        - difference
        - intersect
      type:
        enum:
        - value
      value:
        oneOf:
        - type: array
        - type: string
        - type: boolean
        - type: number
        - type: 'null'
      value_from:
        additionalProperties: 'False'
        properties:
          expr:
            oneOf:
            - type: integer
            - type: string
          format:
            enum:
            - csv
            - json
            - txt
            - csv2dict
          url:
            type: string
        required:
        - url
        type: object
      value_regex:
        type: string
      value_type:
        enum:
        - age
        - integer
        - expiration
        - normalize
        - size
        - cidr
        - cidr_size
        - swap
        - resource_count
        - expr
        - unique_size
        - date
    required:
    - type




