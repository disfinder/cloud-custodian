

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Testing for Developers &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/icon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/js/expand.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/expand.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Documentation For Developers" href="documentation.html" />
    <link rel="prev" title="Installing for Developers" href="installing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filters.html">Generic Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../actions.html">Generic Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/advanced.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart/policyStructure.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment.html">Deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">AWS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../aws/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/examples/index.html">Example Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/aws-modes.html">AWS Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws/resources/index.html">AWS Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Azure</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../azure/gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/authentication.html">Authentication &amp; Access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/policy/index.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/azure-modes.html">Azure Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/advanced/index.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/contribute.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../azure/resources/index.html">Azure Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">GCP</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../gcp/gettingstarted.html">Getting Started (Beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/gcp-modes.html">GCP Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/policy/index.html">Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/contribute.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/contribute.html#adding-new-gcp-resources">Adding New GCP Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/contribute.html#testing">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcp/resources/index.html">GCP Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/c7n-org.html">c7n-org: Multi Account Custodian Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/c7n-policystream.html">c7n-policystream: Policy Changes from Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/c7n-mailer.html">c7n-mailer: Custodian Mailer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/c7n-trailcreator.html">AWS Retroactive Tagging Resource Creators</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing.html">Installing for Developers</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Testing for Developers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#running-tests">Running tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#operating-system-compatibility">Operating System Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#decorating-tests">Decorating tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-placebo-tests-for-aws-resources">Writing Placebo Tests for AWS Resources</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Documentation For Developers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Cloud Custodian</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Testing for Developers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="testing-for-developers">
<span id="developer-tests"></span><h1>Testing for Developers<a class="headerlink" href="#testing-for-developers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>Unit tests can be run with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tox
</pre></div>
</div>
<p>Linting can be run with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ make lint
</pre></div>
</div>
</div>
<div class="section" id="operating-system-compatibility">
<h2>Operating System Compatibility<a class="headerlink" href="#operating-system-compatibility" title="Permalink to this headline">¶</a></h2>
<p>Tests are currently executed on both Ubuntu 1604 and Windows Server 2019
and must pass on both operating systems.</p>
<p>Both Windows and Linux sample dockerfiles are provided for running Tox which may help you.
You can find these in <cite>tools/dev</cite>.</p>
<p>In Docker for Windows you can run both of these containers,
<a class="reference external" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/linux-containers">even simultaneously</a>.</p>
<p>If you need access to Windows you can download a
<a class="reference external" href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines">virtual machine</a>
directly from Microsoft for any hypervisor.</p>
</div>
<div class="section" id="decorating-tests">
<h2>Decorating tests<a class="headerlink" href="#decorating-tests" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">functional</span></code> decorator marks tests that don’t require any pre-existing
AWS context, and can therefore be run cleanly against live AWS.</p>
<p>To run only the tests decorated by <code class="docutils literal notranslate"><span class="pre">functional</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(py37)$ pytest tests/test_vpc.py -x -m functional
</pre></div>
</div>
</div>
<div class="section" id="writing-placebo-tests-for-aws-resources">
<h2>Writing Placebo Tests for AWS Resources<a class="headerlink" href="#writing-placebo-tests-for-aws-resources" title="Permalink to this headline">¶</a></h2>
<p>Note: These instructions are only for recording data in AWS. For Azure, GCP, or
other cloud providers, see the corresponding documentation for information on how
to record data there.</p>
<p>The <a class="reference external" href="http://placebo.readthedocs.io/en/latest/">Placebo</a> library is used to
record and replay AWS responses so that tests can run locally, and in a fraction
of the time it would take to interact with live AWS services.</p>
<p>In order to write a placebo test two helper methods are provided:</p>
<blockquote>
<div><ul class="simple">
<li><p><cite>record_flight_data</cite> - use this when creating the test</p></li>
<li><p><cite>replay_flight_data</cite> - use this when the test is completed</p></li>
</ul>
</div></blockquote>
<p>When first creating a test, use the <cite>record_flight_data</cite> method.  This will
contact AWS and store all responses as files in the placebo directory
(<cite>tests/data/placebo/</cite>).  The method takes one parameter, which is the directory
name to store placebo output in and it must be unique across all tests.  For
example:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">    <span class="n">session_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_flight_data</span><span class="p">(</span>
</span><span class="hll">        <span class="s1">&#39;test_example&#39;</span><span class="p">)</span>
</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;list-ec2-instances&#39;</span><span class="p">,</span>
        <span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="s1">&#39;ec2&#39;</span>
    <span class="p">}</span>

    <span class="n">policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_policy</span><span class="p">(</span>
        <span class="n">policy</span><span class="p">,</span>
        <span class="n">session_factory</span><span class="o">=</span><span class="n">session_factory</span><span class="p">)</span>

    <span class="n">resources</span> <span class="o">=</span> <span class="n">policy</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resources</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Now run this test using the following command to generate the placebo data:</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ nosetests -s -v tests/path/to/test.py
</pre></div>
</div>
</div></blockquote>
<p>This may take a little while as the test is contacting AWS.
All responses are stored in the placebo dir, and can be viewed when the test is
finished.  It is not necessary to inspect these files, but they can be helpful
if the test is not behaving how you expect.</p>
<blockquote>
<div><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ls tests/data/placebo/test_example/
ec2.DescribeInstances_1.json
ec2.DescribeTags_1.json
</pre></div>
</div>
</div></blockquote>
<p>If it is necessary to run the test again - for example, if the test fails, or if
it is not yet fully complete - you can run with <cite>record_flight_data</cite> as many
times as necessary.  The contents of the directory will be cleared each time the
test is run while <cite>record_flight_data</cite> is in place.</p>
<p>When the test is completed, change to using <cite>replay_flight_data</cite>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_example</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="hll">    <span class="n">session_factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replay_flight_data</span><span class="p">(</span>
</span><span class="hll">        <span class="s1">&#39;test_example&#39;</span><span class="p">)</span>
</span>
    <span class="o">...</span>
</pre></div>
</div>
</div></blockquote>
<p>Now when the test is run it will use the data previously recorded and will not
contact AWS.  When committing your test, don’t forget to include the
<cite>tests/data/placebo/test_example</cite> directory!</p>
<p>Note: if it’s necessary to delay CLI calls due to delays in the time it takes
for an attribute on a resource to be reflected in an API call or any other reason,
use <code class="docutils literal notranslate"><span class="pre">self.recording</span></code> to only sleep when recording json like so:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="o">...</span>

<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recording</span><span class="p">:</span>
  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="documentation.html" class="btn btn-neutral float-right" title="Documentation For Developers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installing.html" class="btn btn-neutral float-left" title="Installing for Developers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Capital One Services, LLC

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>